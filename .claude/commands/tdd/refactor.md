---
description: TDDリファクタリングフェーズ - テストを保ちながらコードを整理・改善
---

# TDD - リファクタリングフェーズ（Refactor Phase）

## 目的
テストが通っている状態を維持しながら、コードの品質を向上させます。

## 前提条件
- すべてのテストが通っていることを確認済み

## 実施手順

1. **リファクタリング対象の特定**
   - コードの重複
   - 読みにくい処理
   - 不適切な命名
   - 長すぎる関数やメソッド

2. **小さな変更を繰り返す**
   - 一度に1つの改善を行う
   - 各変更後にテストを実行
   - テストが通ることを確認してから次の変更へ

3. **過度なリファクタリングの回避**
   - 将来の要件のための抽象化は行わない
   - 1回しか使わない処理のためのヘルパーは作らない
   - 3回使われるまで抽象化しない（Rule of Three）

## テスト実行例

各変更後に必ずテストを実行します：

### Python
```bash
# uv.lockがある場合
uv run python -m pytest -v

# poetry.lockがある場合
poetry run python -m pytest -v

# それ以外
python -m pytest -v
```

### Go
```bash
go test ./... -v
```

### Node.js
```bash
npm test
```

## リファクタリングの種類

### 推奨されるリファクタリング

- **重複の削除**: 同じコードが複数箇所に存在する場合
- **命名の改善**: 意図が明確になる名前に変更
- **関数の分割**: 長すぎる関数を意味のある単位に分割
- **マジックナンバーの除去**: 定数として定義。文字列も定数化を考慮する

### 避けるべきリファクタリング

- **過度な抽象化**: 将来の拡張性のための複雑な設計
- **早すぎる最適化**: パフォーマンスボトルネックでない箇所の最適化
- **不要なデザインパターン**: 問題を複雑にするパターンの適用
- **過度な汎用化**: 現在の要件を超える柔軟性の追加

## 重要な原則

- **テストの実行**: 各変更後に必ずテストを実行
- **段階的な変更**: 大きな変更は小さなステップに分割
- **後方互換性**: 未使用のコードは完全に削除（ハックは不要）
- **コメント**: WHYを書く（なぜこの構造を選んだか）

## 次のステップ

リファクタリングが完了したら、新しい機能を追加する場合は再び `/tdd-red` から開始
